name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ====== JOB: LINT ======
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Python syntax
        run: python -m py_compile src/*.py tests/*.py
      
      - name: Run pylint
        run: pylint src/ --exit-zero
        continue-on-error: true

  # ====== JOB: TEST ======
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html --cov-report=term
      
      - name: Check code coverage (minimum 50%)
        run: |
          COVERAGE=$(grep -oP 'TOTAL\s+\d+\s+\d+\s+\K(\d+)(?=%)' coverage.xml || echo "0")
          echo "Code Coverage: $COVERAGE%"
          if [ "$COVERAGE" -lt 50 ]; then
            echo "❌ Code coverage $COVERAGE% is below minimum 50%"
            exit 1
          fi
          echo "✅ Code coverage $COVERAGE% meets minimum requirement"
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

  # ====== JOB: BUILD (тільки для main) ======
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create build directory
        run: |
          mkdir -p build
          cp -r src/ build/
          cp -r tests/ build/
          cp requirements.txt build/
          echo "Build completed successfully!"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: build/
          retention-days: 30
      
      - name: Create release
        run: echo "✅ Ready for deployment!"
